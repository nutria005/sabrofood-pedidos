<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Sistema de gestiÃ³n de pedidos para reparto - Conectado a Supabase">
  <meta name="theme-color" content="#059669">
  <title>ğŸšš Repartidor | Sistema de Pedidos</title>
  <link rel="stylesheet" href="style.css?v=20251221">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="../shared/supabase-config.js?v=20251217"></script>
  <script src="../shared/auth.js?v=20251217"></script>
  <script src="script.js?v=20251217" defer></script>
</head>
<body>
  <!-- ProtecciÃ³n de ruta con Firebase Authentication -->
  <script type="module">
    import { protegerRuta } from '../shared/auth-guard.js';
    
    // Proteger esta pÃ¡gina - redirige a login si no estÃ¡ autenticado
    protegerRuta().catch(() => {
      console.log('Redirigiendo a login...');
    });
  </script>
  
  <div class="wrap">
    <header style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:8px;">
      <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
        <h1 class="title">ğŸšš Repartidor</h1>
        <span style="background:#059669;color:white;padding:4px 12px;border-radius:6px;font-size:0.75rem;font-weight:600;letter-spacing:0.5px;">MODO: REPARTO</span>
      </div>
      <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
        <div style="display:flex;align-items:center;gap:6px;background:#f3f4f6;padding:4px 10px;border-radius:8px;" title="Ajustar densidad de vista">
          <span style="font-size:0.85rem;">ğŸ“</span>
          <input type="range" id="densitySlider" min="0.6" max="1.1" step="0.05" value="1" style="width:80px;cursor:pointer;" aria-label="Control de densidad">
          <span id="densityValue" style="font-size:0.75rem;color:#6b7280;min-width:35px;">100%</span>
        </div>
        
        <div id="contadorProgreso" style="background:#f3f4f6;padding:6px 12px;border-radius:8px;font-size:0.9rem;font-weight:600;color:#374151;display:flex;gap:4px;align-items:center;" title="Entregados / Anulados / Total">
          <span id="contadorEntregados" style="color:#059669;">âœ… 0</span>
          <span style="color:#9ca3af;">/</span>
          <span id="contadorAnulados" style="color:#6b7280;">ğŸš« 0</span>
          <span style="color:#9ca3af;">/</span>
          <span id="contadorTotal" style="color:#374151;">ğŸ“¦ 0</span>
        </div>
        
        <button id="btnVerCarga" class="btn-ver-carga" aria-label="Ver resumen de carga">
          ğŸ“¦ Ver Carga
        </button>
        
        <div id="connectionStatus" class="connection-status online" role="status" aria-live="polite">
          <span class="status-icon" aria-hidden="true">ğŸŸ¢</span>
          <span class="status-text">Online</span>
        </div>
        
        <div id="offlineCounter" class="offline-counter" style="display:none;" role="status" aria-live="polite">
          <span class="counter-icon" aria-hidden="true">ğŸ“¡</span>
          <span class="counter-text" id="offlineCounterText">0</span>
        </div>
        
        <div id="status" style="font-size:13px;color:var(--muted);" role="status">Estado: Conectando...</div>
        
        <a href="../index.html" id="btnCerrarSesion" class="ghost" style="font-size:11px;padding:4px 8px;text-decoration:none;display:inline-block;" title="Cerrar SesiÃ³n" aria-label="Cerrar sesiÃ³n">
          ğŸ”’ Salir
        </a>
      </div>
    </header>

    <!-- Selector de Chofer Mejorado -->
    <div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);padding:20px;border-radius:16px;margin-bottom:20px;box-shadow:0 8px 16px rgba(0,0,0,0.15);">
      <label for="selectorChofer" style="display:block;font-weight:700;color:#fff;margin-bottom:12px;font-size:18px;text-align:center;text-shadow:0 2px 4px rgba(0,0,0,0.2);">ğŸšš Selecciona tu perfil</label>
      <select id="selectorChofer" style="width:100%;padding:14px 16px;font-size:18px;font-weight:600;border:none;border-radius:10px;background:#fff;cursor:pointer;box-shadow:0 4px 8px rgba(0,0,0,0.1);transition:all 0.3s ease;" aria-label="Seleccionar repartidor">
        <option value="" style="color:#9ca3af;">ğŸ‘¤ Elige tu nombre...</option>
        <option value="repartidor_1" style="font-weight:600;">ğŸšš Repartidor 1</option>
        <option value="repartidor_2" style="font-weight:600;">ğŸšš Repartidor 2</option>
      </select>
    </div>

    <section class="resumen-caja-panel" aria-labelledby="resumen-title">
      <div class="resumen-caja-card">
        <h3 id="resumen-title">ğŸ’° RecaudaciÃ³n del DÃ­a</h3>
        
        <div class="total-general">
          <span class="total-label">ğŸ’° TOTAL RECAUDADO:</span>
          <span class="total-valor" id="totalRendir" aria-live="polite">$0</span>
        </div>
        
        <div class="resumen-grid-cuadre">
          <div class="resumen-item efectivo">
            <span class="resumen-label">ğŸ’µ Efectivo</span>
            <span class="resumen-valor" id="totalEfectivo" aria-live="polite">$0</span>
            <small class="resumen-detalle" id="cantidadEfectivo">0 pedidos</small>
          </div>
          
          <div class="resumen-item tarjetas">
            <span class="resumen-label">ğŸ’³ DÃ©bito/CrÃ©dito</span>
            <span class="resumen-valor" id="totalTarjetas" aria-live="polite">$0</span>
            <small class="resumen-detalle" id="cantidadTarjetas">0 pedidos</small>
          </div>
          
          <div class="resumen-item transferencias">
            <span class="resumen-label">â³ Transf. Pendientes</span>
            <span class="resumen-valor" id="totalTransferencias" aria-live="polite">$0</span>
            <small class="resumen-detalle" id="cantidadTransferencias">0 pedidos</small>
          </div>
          
          <div class="resumen-item pagados">
            <span class="resumen-label">âœ… Transf. Pagadas</span>
            <span class="resumen-valor" id="totalPagados" aria-live="polite">$0</span>
            <small class="resumen-detalle" id="cantidadPagados">0 pedidos</small>
          </div>
        </div>
      </div>
    </section>

    <div class="grid">
      <section class="card" aria-labelledby="pedidos-title">
        <h2 id="pedidos-title" class="sr-only">Lista de Pedidos</h2>
        
        <div class="flex flex-gap-8" style="margin-bottom:12px;">
          <div class="flex flex-gap-8 flex-center">
            <label for="filterDate" class="sr-only">Filtrar por fecha</label>
            <input id="filterDate" type="date" title="Filtrar por fecha de entrega" aria-label="Filtrar por fecha de entrega" />
            
            <div class="filtros-rapidos" role="group" aria-label="Filtros rÃ¡pidos de fecha">
              <button id="btnHoy" class="ghost filtro-fecha" type="button" data-filtro="hoy" aria-label="Mostrar pedidos de hoy">
                ğŸ“… Hoy
              </button>
              <button id="btnManana" class="ghost filtro-fecha" type="button" data-filtro="manana" aria-label="Mostrar pedidos de maÃ±ana">
                ğŸ“… MaÃ±ana
              </button>
              <button id="btnMes" class="ghost filtro-fecha active" type="button" data-filtro="mes" aria-label="Mostrar pedidos del mes" aria-pressed="true">
                ğŸ“† Este Mes
              </button>
            </div>
          </div>
          
          <label for="buscador" class="sr-only">Buscar pedidos</label>
          <input id="buscador" type="search" placeholder="Buscar por telÃ©fono, nombre, producto o fecha..." aria-label="Buscar pedidos" />
          
          <button id="btnBuscar" class="ghost" style="width:120px;" aria-label="Realizar bÃºsqueda">Buscar</button>
          
          <div id="resultCount" style="min-width:120px;text-align:right;font-size:13px;color:var(--muted);align-self:center;" aria-live="polite" aria-atomic="true">
            --
          </div>
        </div>
        
        <div id="resultados" class="results" role="region" aria-live="polite" aria-busy="false">
          <div class="item">Cargando datos desde la nube...</div>
        </div>
        
        <!-- SecciÃ³n de Pedidos Entregados -->
        <div id="seccionEntregados" style="margin-top:40px;display:none;">
          <h3 style="font-size:20px;font-weight:700;color:#059669;margin-bottom:16px;padding-bottom:8px;border-bottom:2px solid #059669;display:flex;align-items:center;gap:8px;">
            âœ… Entregados Hoy
            <span id="contadorEntregadosHoy" style="background:#d1fae5;color:#065f46;padding:4px 12px;border-radius:6px;font-size:14px;">0</span>
          </h3>
          <div id="resultadosEntregados" class="results results-entregados" role="region" aria-label="Pedidos entregados">
            <!-- AquÃ­ se renderizarÃ¡n los pedidos entregados -->
          </div>
        </div>
      </section>
    </div>
  </div>

  <div id="histModal" class="modal-backdrop" role="dialog" aria-hidden="true" aria-labelledby="histModalTitle">
    <div class="modal" role="document">
      <div class="modal-header">
        <strong id="histModalTitle">Historial del Cliente</strong>
        <div>
          <button id="histExport" class="ghost" style="margin-right:8px;" aria-label="Exportar historial">
            Exportar
          </button>
          <button id="histClose" class="modal-close" aria-label="Cerrar historial">
            Cerrar
          </button>
        </div>
      </div>
      <div id="histModalBody" class="modal-body"></div>
    </div>
  </div>

  <!-- NOTA: BotÃ³n de agregar pedido removido - Los repartidores solo pueden visualizar pedidos asignados -->

  <div id="formModalBackdrop" 
       style="position:fixed;inset:0;background:rgba(30,41,59,.18);display:none;align-items:center;justify-content:center;z-index:9999;"
       role="dialog"
       aria-hidden="true"
       aria-labelledby="formModalTitle">
    <div id="formModal" 
         style="background:#fff;border-radius:18px;box-shadow:0 10px 30px rgba(30,41,59,.18);max-width:540px;width:100%;padding:32px 28px;position:relative;max-height:90vh;overflow-y:auto;">
      
      <button id="btnCloseForm" 
              style="position:absolute;top:18px;right:18px;background:#f3f4f6;color:#374151;border:none;border-radius:8px;padding:4px 12px;cursor:pointer;font-size:1.2rem;"
              aria-label="Cerrar formulario">
        âœ•
      </button>
      
      <form id="formAgregar" onsubmit="return false;" novalidate>
        
        <fieldset class="form-section">
          <legend class="section-title">ğŸ‘¤ Datos del Cliente</legend>
          
          <div class="form-row">
            <label for="telefono" class="sr-only">TelÃ©fono del cliente</label>
            <input id="telefono" type="tel" placeholder="ğŸ“± TelÃ©fono (Obligatorio)" style="margin-bottom:8px;" required aria-required="true" />
          </div>
          
          <div class="form-row">
            <label for="nombre" class="sr-only">Nombre del cliente</label>
            <input id="nombre" type="text" placeholder="ğŸ‘¤ Nombre (opcional)" style="margin-bottom:8px;" />
          </div>
          
          <div class="form-row">
            <label for="direccion" class="sr-only">DirecciÃ³n de entrega</label>
            <input id="direccion" type="text" placeholder="ğŸ“ DirecciÃ³n de entrega" style="margin-bottom:8px;" />
          </div>
        </fieldset>
        
        <div id="historialPreview" class="historial-preview" style="display:none; margin-bottom:16px;" aria-live="polite">
          <div class="historial-header">
            <span class="historial-title">ğŸ“š Historial del Cliente</span>
            <span class="historial-count" id="historialCount"></span>
          </div>
          <div id="historialContent" class="historial-content">
            <div class="historial-loading">ğŸ” Buscando historial...</div>
          </div>
        </div>
        
        <fieldset class="form-section">
          <legend class="section-title">ğŸ“… Fecha y Ruta</legend>
          
          <div class="form-row-grid">
            <div class="form-field">
              <label for="fechaEntrega" class="form-label">Fecha de Entrega</label>
              <input id="fechaEntrega" type="date" style="font-size:1.05rem;" required aria-required="true" />
            </div>
            
            <div class="form-field">
              <label for="rutaSelect" class="form-label">Ruta</label>
              <select id="rutaSelect" style="font-size:1.05rem;" aria-label="Seleccionar ruta de entrega">
                <option value="A">ğŸ”´ Ruta A - Alta</option>
                <option value="B">ğŸŸ¡ Ruta B - Media</option>
                <option value="C">ğŸŸ¢ Ruta C - Baja</option>
              </select>
            </div>
          </div>
        </fieldset>
        
        <fieldset class="form-section">
          <legend class="section-title">ğŸ›’ Productos del Pedido</legend>
          
          <div class="form-row" style="display:grid;grid-template-columns:0.7fr 2fr 1fr 1fr;gap:8px;align-items:center;margin-bottom:8px;">
            <label for="itemCantidad" class="sr-only">Cantidad</label>
            <input id="itemCantidad" type="number" min="1" value="1" placeholder="Cant." style="width:100%;" aria-label="Cantidad de producto" />
            
            <label for="itemProducto" class="sr-only">Producto</label>
            <input id="itemProducto" type="text" placeholder="Producto (ej. Cat Chow 3kg)" style="width:100%;" aria-label="Nombre del producto" />
            
            <label for="itemPrecio" class="sr-only">Precio</label>
            <input id="itemPrecio" type="number" min="0" step="1" placeholder="Precio" style="width:100%;" aria-label="Precio del producto" />
            
            <button type="button" id="btnAnadirItem" class="ghost" style="width:100%;font-size:1.1rem;" aria-label="AÃ±adir producto al pedido">
              â•
            </button>
          </div>
          
          <div id="lineasPedidoContainer" style="margin:10px 0 0 0;" role="list" aria-label="Lista de productos en el pedido"></div>
          
          <div id="pedidoTotalDisplay" style="font-weight:700;color:#16a34a;text-align:right;margin-bottom:8px;font-size:1.3rem;" aria-live="polite"></div>
        </fieldset>
        
        <fieldset class="form-section">
          <legend class="section-title">ğŸ’³ MÃ©todo de Pago</legend>
          
          <div class="form-row" style="margin-bottom:8px;">
            <label for="metodoPago" class="sr-only">MÃ©todo de pago</label>
            <select id="metodoPago" style="font-size:1.05rem;" aria-label="Seleccionar mÃ©todo de pago">
              <option value="E">ğŸ’µ Efectivo</option>
              <option value="DC">ğŸ’³ DÃ©bito/CrÃ©dito</option>
              <option value="TP">â³ Transf. Pendiente</option>
              <option value="TG">âœ… Transf. Pagada</option>
              <option value="P">ğŸ’° Pagado</option>
            </select>
          </div>
        </fieldset>
        
        <fieldset class="form-section">
          <legend class="section-title">ğŸ“ Notas Adicionales</legend>
          
          <div class="form-row" style="margin-bottom:12px;">
            <label for="notas" class="sr-only">Notas adicionales</label>
            <textarea id="notas" rows="3" placeholder="Observaciones, detalles especiales, instrucciones de entrega..." style="resize:vertical;" aria-label="Notas y observaciones del pedido"></textarea>
          </div>
        </fieldset>
        
        <div style="display:flex;gap:10px;margin-bottom:8px;">
          <button id="btnAgregar" type="submit" style="flex:1;font-size:1.1rem;" aria-label="Guardar nuevo pedido">
            Agregar Pedido
          </button>
          <button id="btnLimpiar" class="ghost" type="button" style="flex:1;font-size:1.1rem;" aria-label="Limpiar formulario">
            Limpiar
          </button>
        </div>
      </form>
    </div>
  </div>
  
  <div id="modalCarga" class="modal-carga-backdrop" style="display:none;" role="dialog" aria-hidden="true" aria-labelledby="modalCargaTitle">
    <div class="modal-carga">
      <div class="modal-carga-header">
        <h3 id="modalCargaTitle">ğŸ“¦ Manifiesto de Carga</h3>
        <button id="btnCerrarCarga" class="btn-cerrar-modal" aria-label="Cerrar resumen de carga">âœ•</button>
      </div>
      <div id="modalCargaBody" class="modal-carga-body"></div>
      <div class="modal-carga-footer">
        <div class="total-bultos">
          <span class="total-bultos-label">Total Bultos:</span>
          <span class="total-bultos-numero" id="totalBultos">0</span>
        </div>
      </div>
    </div>
  </div>

  <style>
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border-width: 0;
    }
  </style>
  
  <audio id="audio-notificacion" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto" style="display:none;"></audio>
</body>
</html>
